<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-light: #f8fafc;
            --bg-dark: #0f172a;
            --card-light: #ffffff;
            --card-dark: #1e293b;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --border-light: #e2e8f0;
            --border-dark: #334155;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        body.dark {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--card-light);
            border-right: 1px solid var(--border-light);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .dark .sidebar {
            background: var(--card-dark);
            border-right-color: var(--border-dark);
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 2rem;
        }

        .dark .sidebar-header {
            border-bottom-color: var(--border-dark);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin: 0.5rem 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 2rem;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-left h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            color: #64748b;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .theme-toggle {
            background: none;
            border: 1px solid var(--border-light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dark .theme-toggle {
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-light);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .dark .stat-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .positive {
            color: var(--secondary-color);
        }

        .negative {
            color: var(--danger-color);
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--card-light);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
        }

        .dark .chart-card {
            background: var(--card-dark);
            border-color: var(--border-dark);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Trade Form */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            background: var(--card-light);
            color: inherit;
            transition: all 0.3s ease;
        }

        .dark .form-input, .dark .form-select, .dark .form-textarea {
            border-color: var(--border-dark);
            background: var(--card-dark);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        /* Tables */
        .table-container {
            background: var(--card-light);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
        }

        .dark .table-container {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .dark .table th, .dark .table td {
            border-bottom-color: var(--border-dark);
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dark .table th {
            background: #0f172a;
        }

        /* Calendar */
        .calendar-container {
            background: var(--card-light);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-light);
        }

        .dark .calendar-container {
            background: var(--card-dark);
            border-color: var(--border-dark);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-light);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .dark .calendar-grid {
            background: var(--border-dark);
        }

        .calendar-day {
            background: var(--card-light);
            padding: 1rem;
            text-align: center;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .dark .calendar-day {
            background: var(--card-dark);
        }

        .calendar-day.profit {
            background: rgba(16, 185, 129, 0.1);
        }

        .calendar-day.loss {
            background: rgba(239, 68, 68, 0.1);
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-light);
            border-radius: 0.5rem 0.5rem 0 0;
            overflow: hidden;
            margin-bottom: 1px;
        }

        .calendar-header div {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>📈</span>
                    <span>TradingJournal Pro</span>
                </div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-section="dashboard">
                            <span class="nav-icon">📊</span>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="journal">
                            <span class="nav-icon">📝</span>
                            <span>Trade Journal</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="reports">
                            <span class="nav-icon">📈</span>
                            <span>Reports</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="calendar">
                            <span class="nav-icon">📅</span>
                            <span>Calendar</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="settings">
                            <span class="nav-icon">⚙️</span>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1>Trading Dashboard</h1>
                    <p class="header-subtitle">Track your trading performance and improve your strategy</p>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" onclick="toggleTheme()">🌓 Theme</button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total P&L</div>
                        </div>
                        <div class="stat-value positive" id="total-pnl">$0.00</div>
                        <div class="stat-change positive" id="pnl-change">+0.00% this month</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Win Rate (Trades)</div>
                        </div>
                        <div class="stat-value" id="win-rate-trades">0%</div>
                        <div class="stat-change" id="trades-count">0 trades total</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Win Rate (Days)</div>
                        </div>
                        <div class="stat-value" id="win-rate-days">0%</div>
                        <div class="stat-change" id="days-traded">0 days traded</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Profit Factor</div>
                        </div>
                        <div class="stat-value" id="profit-factor">0.00</div>
                        <div class="stat-change" id="avg-trade">$0.00 avg trade</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Average Win</div>
                        </div>
                        <div class="stat-value positive" id="avg-win">$0.00</div>
                        <div class="stat-change" id="largest-win">$0.00 largest</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Average Loss</div>
                        </div>
                        <div class="stat-value negative" id="avg-loss">$0.00</div>
                        <div class="stat-change" id="largest-loss">$0.00 largest</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Cumulative P&L</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="pnlChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Win/Loss Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="winLossChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Journal Section -->
            <section id="journal" class="section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Add New Trade</h3>
                    </div>
                    
                    <form id="trade-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" id="trade-date" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Symbol</label>
                                <input type="text" class="form-input" id="symbol" placeholder="AAPL" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Direction</label>
                                <select class="form-select" id="direction" required>
                                    <option value="">Select</option>
                                    <option value="long">Long</option>
                                    <option value="short">Short</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-input" id="quantity" placeholder="100" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Entry Price</label>
                                <input type="number" class="form-input" id="entry-price" step="0.01" placeholder="150.00" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Exit Price</label>
                                <input type="number" class="form-input" id="exit-price" step="0.01" placeholder="155.00" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Stop Loss</label>
                                <input type="number" class="form-input" id="stop-loss" step="0.01" placeholder="145.00">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Take Profit</label>
                                <input type="number" class="form-input" id="take-profit" step="0.01" placeholder="160.00">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes & Emotions</label>
                            <textarea class="form-textarea" id="trade-notes" placeholder="What was your thought process? How did you feel during this trade? What did you learn?"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-input" id="tags" placeholder="discipline-error, A+ setup, overtraded">
                        </div>
                        
                        <button type="submit" class="btn">Add Trade</button>
                    </form>
                </div>

                <!-- Trades Table -->
                <div class="table-container" style="margin-top: 2rem;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>Quantity</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                                <th>R Multiple</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table">
                            <!-- Trades will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Performance Analytics</h3>
                    </div>
                    
                    <div class="charts-grid" style="margin-top: 2rem;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Monthly P&L</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">R-Multiple Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="rMultipleChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Metrics -->
                    <div class="stats-grid" style="margin-top: 2rem;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Maximum Drawdown</div>
                            </div>
                            <div class="stat-value negative" id="max-drawdown">0%</div>
                            <div class="stat-change" id="drawdown-period">No drawdown period</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Largest Win Streak</div>
                            </div>
                            <div class="stat-value positive" id="win-streak">0</div>
                            <div class="stat-change" id="current-streak">Current: 0</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">Largest Loss Streak</div>
                            </div>
                            <div class="stat-value negative" id="loss-streak">0</div>
                            <div class="stat-change" id="current-loss-streak">Current: 0</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Calendar Section -->
            <section id="calendar" class="section">
                <div class="calendar-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Trading Calendar</h3>
                        <div>
                            <button class="btn-secondary btn" onclick="changeMonth(-1)">← Prev</button>
                            <span id="calendar-month" style="margin: 0 1rem; font-weight: 600;"></span>
                            <button class="btn-secondary btn" onclick="changeMonth(1)">Next →</button>
                        </div>
                    </div>
                    
                    <div class="calendar-header">
                        <div>Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>
                    
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Settings & Data Management</h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Import Trades from CSV</label>
                        <input type="file" class="form-input" id="csv-import" accept=".csv">
                        <button class="btn" style="margin-top: 1rem;" onclick="importCSV()">Import CSV</button>
                    </div>
                    
                    <div class="form-group" style="margin-top: 2rem;">
                        <label class="form-label">Export Data</label>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn-secondary btn" onclick="exportToCSV()">Export to CSV</button>
                            <button class="btn-secondary btn" onclick="exportToJSON()">Export to JSON</button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 2rem;">
                        <label class="form-label">Clear All Data</label>
                        <button class="btn" style="background: var(--danger-color); margin-top: 1rem;" onclick="clearAllData()">Clear All Trades</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Application State
        let trades = JSON.parse(localStorage.getItem('trades') || '[]');
        let currentSection = 'dashboard';
        let currentMonth = new Date();
        let charts = {};

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            updateDashboard();
            renderTradesTable();
            renderCalendar();
            setTodayDate();
            
            // Add sample trades if none exist
            if (trades.length === 0) {
                addSampleTrades();
            }
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    switchSection(section);
                });
            });

            // Trade form
            document.getElementById('trade-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addTrade();
            });
        }

        function switchSection(sectionName) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');

            currentSection = sectionName;

            // Initialize section-specific content
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'reports') {
                updateReports();
            } else if (sectionName === 'calendar') {
                renderCalendar();
            }
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('trade-date').value = today;
        }

        function addSampleTrades() {
            const sampleTrades = [
                {
                    id: 1,
                    date: '2024-01-15',
                    symbol: 'AAPL',
                    direction: 'long',
                    quantity: 100,
                    entryPrice: 185.50,
                    exitPrice: 192.30,
                    stopLoss: 180.00,
                    takeProfit: 195.00,
                    notes: 'Strong earnings report, bought on dip. Held through volatility.',
                    tags: 'earnings-play, A+ setup',
                    pnl: 680.00,
                    rMultiple: 1.24
                },
                {
                    id: 2,
                    date: '2024-01-16',
                    symbol: 'TSLA',
                    direction: 'short',
                    quantity: 50,
                    entryPrice: 238.45,
                    exitPrice: 233.20,
                    stopLoss: 245.00,
                    takeProfit: 225.00,
                    notes: 'Overvalued after pump, shorted resistance. Good timing.',
                    tags: 'mean-reversion, discipline',
                    pnl: 262.50,
                    rMultiple: 0.80
                },
                {
                    id: 3,
                    date: '2024-01-17',
                    symbol: 'SPY',
                    direction: 'long',
                    quantity: 200,
                    entryPrice: 478.20,
                    exitPrice: 475.10,
                    stopLoss: 475.00,
                    takeProfit: 485.00,
                    notes: 'Bad entry, market turned against me. Cut losses quickly.',
                    tags: 'discipline-error, cut-losses',
                    pnl: -620.00,
                    rMultiple: -0.97
                }
            ];
            
            trades.push(...sampleTrades);
            saveTrades();
        }

        function addTrade() {
            const formData = {
                id: Date.now(),
                date: document.getElementById('trade-date').value,
                symbol: document.getElementById('symbol').value.toUpperCase(),
                direction: document.getElementById('direction').value,
                quantity: parseInt(document.getElementById('quantity').value),
                entryPrice: parseFloat(document.getElementById('entry-price').value),
                exitPrice: parseFloat(document.getElementById('exit-price').value),
                stopLoss: parseFloat(document.getElementById('stop-loss').value) || null,
                takeProfit: parseFloat(document.getElementById('take-profit').value) || null,
                notes: document.getElementById('trade-notes').value,
                tags: document.getElementById('tags').value
            };

            // Calculate P&L and R-multiple
            const pnl = calculatePnL(formData);
            const rMultiple = calculateRMultiple(formData, pnl);

            formData.pnl = pnl;
            formData.rMultiple = rMultiple;

            trades.push(formData);
            saveTrades();
            
            // Reset form
            document.getElementById('trade-form').reset();
            setTodayDate();
            
            // Update displays
            updateDashboard();
            renderTradesTable();
            renderCalendar();
            
            alert('Trade added successfully!');
        }

        function calculatePnL(trade) {
            const { direction, quantity, entryPrice, exitPrice } = trade;
            let pnl;
            
            if (direction === 'long') {
                pnl = (exitPrice - entryPrice) * quantity;
            } else {
                pnl = (entryPrice - exitPrice) * quantity;
            }
            
            return Math.round(pnl * 100) / 100;
        }

        function calculateRMultiple(trade, pnl) {
            const { direction, entryPrice, stopLoss } = trade;
            if (!stopLoss) return 0;
            
            const risk = Math.abs(entryPrice - stopLoss);
            const rMultiple = pnl / (risk * trade.quantity);
            
            return Math.round(rMultiple * 100) / 100;
        }

        function saveTrades() {
            localStorage.setItem('trades', JSON.stringify(trades));
        }

        function updateDashboard() {
            const stats = calculateStats();
            
            // Update stat cards
            document.getElementById('total-pnl').textContent = `${stats.totalPnL.toFixed(2)}`;
            document.getElementById('total-pnl').className = `stat-value ${stats.totalPnL >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('win-rate-trades').textContent = `${stats.winRateTrades}%`;
            document.getElementById('trades-count').textContent = `${stats.totalTrades} trades total`;
            
            document.getElementById('win-rate-days').textContent = `${stats.winRateDays}%`;
            document.getElementById('days-traded').textContent = `${stats.daysTraded} days traded`;
            
            document.getElementById('profit-factor').textContent = stats.profitFactor.toFixed(2);
            document.getElementById('avg-trade').textContent = `${stats.avgTrade.toFixed(2)} avg trade`;
            
            document.getElementById('avg-win').textContent = `${stats.avgWin.toFixed(2)}`;
            document.getElementById('largest-win').textContent = `${stats.largestWin.toFixed(2)} largest`;
            
            document.getElementById('avg-loss').textContent = `${Math.abs(stats.avgLoss).toFixed(2)}`;
            document.getElementById('largest-loss').textContent = `${Math.abs(stats.largestLoss).toFixed(2)} largest`;

            // Update charts
            updatePnLChart();
            updateWinLossChart();
        }

        function calculateStats() {
            if (trades.length === 0) {
                return {
                    totalPnL: 0,
                    winRateTrades: 0,
                    winRateDays: 0,
                    totalTrades: 0,
                    daysTraded: 0,
                    profitFactor: 0,
                    avgTrade: 0,
                    avgWin: 0,
                    avgLoss: 0,
                    largestWin: 0,
                    largestLoss: 0
                };
            }

            const totalPnL = trades.reduce((sum, trade) => sum + trade.pnl, 0);
            const winningTrades = trades.filter(trade => trade.pnl > 0);
            const losingTrades = trades.filter(trade => trade.pnl < 0);
            
            const totalWins = winningTrades.reduce((sum, trade) => sum + trade.pnl, 0);
            const totalLosses = Math.abs(losingTrades.reduce((sum, trade) => sum + trade.pnl, 0));
            
            const uniqueDates = [...new Set(trades.map(trade => trade.date))];
            const dailyPnL = uniqueDates.map(date => {
                return trades
                    .filter(trade => trade.date === date)
                    .reduce((sum, trade) => sum + trade.pnl, 0);
            });
            
            const profitableDays = dailyPnL.filter(pnl => pnl > 0).length;

            return {
                totalPnL: totalPnL,
                winRateTrades: trades.length > 0 ? Math.round((winningTrades.length / trades.length) * 100) : 0,
                winRateDays: dailyPnL.length > 0 ? Math.round((profitableDays / dailyPnL.length) * 100) : 0,
                totalTrades: trades.length,
                daysTraded: uniqueDates.length,
                profitFactor: totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? 999 : 0,
                avgTrade: totalPnL / trades.length,
                avgWin: winningTrades.length > 0 ? totalWins / winningTrades.length : 0,
                avgLoss: losingTrades.length > 0 ? losingTrades.reduce((sum, trade) => sum + trade.pnl, 0) / losingTrades.length : 0,
                largestWin: winningTrades.length > 0 ? Math.max(...winningTrades.map(trade => trade.pnl)) : 0,
                largestLoss: losingTrades.length > 0 ? Math.min(...losingTrades.map(trade => trade.pnl)) : 0
            };
        }

        function updatePnLChart() {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            
            if (charts.pnlChart) {
                charts.pnlChart.destroy();
            }

            const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
            let cumulativePnL = 0;
            const data = sortedTrades.map(trade => {
                cumulativePnL += trade.pnl;
                return {
                    x: trade.date,
                    y: cumulativePnL
                };
            });

            charts.pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                parser: 'YYYY-MM-DD',
                                displayFormats: {
                                    day: 'MMM DD'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '
                 + value.toFixed(0);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateWinLossChart() {
            const ctx = document.getElementById('winLossChart').getContext('2d');
            
            if (charts.winLossChart) {
                charts.winLossChart.destroy();
            }

            const winningTrades = trades.filter(trade => trade.pnl > 0).length;
            const losingTrades = trades.filter(trade => trade.pnl < 0).length;

            charts.winLossChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Wins', 'Losses'],
                    datasets: [{
                        data: [winningTrades, losingTrades],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderTradesTable() {
            const tbody = document.getElementById('trades-table');
            tbody.innerHTML = '';

            const sortedTrades = [...trades].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.symbol}</td>
                    <td style="text-transform: capitalize;">${trade.direction}</td>
                    <td>${trade.quantity}</td>
                    <td>${trade.entryPrice.toFixed(2)}</td>
                    <td>${trade.exitPrice.toFixed(2)}</td>
                    <td class="${trade.pnl >= 0 ? 'positive' : 'negative'}">${trade.pnl.toFixed(2)}</td>
                    <td class="${trade.rMultiple >= 0 ? 'positive' : 'negative'}">${trade.rMultiple.toFixed(2)}R</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteTrade(${trade.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteTrade(tradeId) {
            if (confirm('Are you sure you want to delete this trade?')) {
                trades = trades.filter(trade => trade.id !== tradeId);
                saveTrades();
                updateDashboard();
                renderTradesTable();
                renderCalendar();
            }
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthSpan = document.getElementById('calendar-month');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            monthSpan.textContent = currentMonth.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });

            // Clear previous calendar
            calendarGrid.innerHTML = '';

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTrades = trades.filter(trade => trade.date === dateStr);
                const dailyPnL = dayTrades.reduce((sum, trade) => sum + trade.pnl, 0);

                if (dayTrades.length > 0) {
                    dayElement.classList.add(dailyPnL >= 0 ? 'profit' : 'loss');
                    dayElement.innerHTML = `
                        <div style="font-weight: 600;">${day}</div>
                        <div style="font-size: 0.75rem; margin-top: 0.25rem;">${dailyPnL.toFixed(0)}</div>
                    `;
                } else {
                    dayElement.textContent = day;
                }

                calendarGrid.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentMonth.setMonth(currentMonth.getMonth() + direction);
            renderCalendar();
        }

        function updateReports() {
            updateMonthlyChart();
            updateRMultipleChart();
            updateRiskMetrics();
        }

        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            if (charts.monthlyChart) {
                charts.monthlyChart.destroy();
            }

            // Group trades by month
            const monthlyData = {};
            trades.forEach(trade => {
                const monthKey = trade.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = 0;
                }
                monthlyData[monthKey] += trade.pnl;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const data = sortedMonths.map(month => ({
                x: month + '-01',
                y: monthlyData[month]
            }));

            charts.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: 'Monthly P&L',
                        data: data,
                        backgroundColor: data.map(d => d.y >= 0 ? '#10b981' : '#ef4444')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                parser: 'YYYY-MM-DD',
                                displayFormats: {
                                    month: 'MMM YYYY'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '
                 + value.toFixed(0);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateRMultipleChart() {
            const ctx = document.getElementById('rMultipleChart').getContext('2d');
            
            if (charts.rMultipleChart) {
                charts.rMultipleChart.destroy();
            }

            // Group trades by R-multiple ranges
            const ranges = {
                'Loss > -2R': 0,
                '-2R to -1R': 0,
                '-1R to 0R': 0,
                '0R to 1R': 0,
                '1R to 2R': 0,
                'Win > 2R': 0
            };

            trades.forEach(trade => {
                const r = trade.rMultiple;
                if (r < -2) ranges['Loss > -2R']++;
                else if (r < -1) ranges['-2R to -1R']++;
                else if (r < 0) ranges['-1R to 0R']++;
                else if (r < 1) ranges['0R to 1R']++;
                else if (r < 2) ranges['1R to 2R']++;
                else ranges['Win > 2R']++;
            });

            charts.rMultipleChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'Trade Count',
                        data: Object.values(ranges),
                        backgroundColor: [
                            '#ef4444', '#f87171', '#fca5a5',
                            '#86efac', '#4ade80', '#10b981'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateRiskMetrics() {
            // Calculate maximum drawdown
            const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
            let cumulativePnL = 0;
            let peak = 0;
            let maxDrawdown = 0;

            sortedTrades.forEach(trade => {
                cumulativePnL += trade.pnl;
                if (cumulativePnL > peak) {
                    peak = cumulativePnL;
                }
                const drawdown = (peak - cumulativePnL) / Math.max(peak, 1) * 100;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            });

            // Calculate win/loss streaks
            let currentStreak = 0;
            let maxWinStreak = 0;
            let maxLossStreak = 0;
            let currentWinStreak = 0;
            let currentLossStreak = 0;

            sortedTrades.forEach(trade => {
                if (trade.pnl > 0) {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    maxLossStreak = Math.max(maxLossStreak, currentLossStreak);
                }
            });

            // Update display
            document.getElementById('max-drawdown').textContent = `${maxDrawdown.toFixed(1)}%`;
            document.getElementById('win-streak').textContent = maxWinStreak;
            document.getElementById('loss-streak').textContent = maxLossStreak;
            document.getElementById('current-streak').textContent = `Current: ${currentWinStreak}`;
            document.getElementById('current-loss-streak').textContent = `Current: ${currentLossStreak}`;
        }

        // Settings functions
        function importCSV() {
            const fileInput = document.getElementById('csv-import');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length < headers.length) continue;
                    
                    const trade = {};
                    headers.forEach((header, index) => {
                        trade[header.toLowerCase().replace(/[^a-z0-9]/g, '')] = values[index];
                    });

                    // Convert to proper format
                    const newTrade = {
                        id: Date.now() + i,
                        date: trade.date || '',
                        symbol: (trade.symbol || '').toUpperCase(),
                        direction: trade.direction || 'long',
                        quantity: parseInt(trade.quantity || 0),
                        entryPrice: parseFloat(trade.entryprice || 0),
                        exitPrice: parseFloat(trade.exitprice || 0),
                        stopLoss: parseFloat(trade.stoploss) || null,
                        takeProfit: parseFloat(trade.takeprofit) || null,
                        notes: trade.notes || '',
                        tags: trade.tags || ''
                    };

                    newTrade.pnl = calculatePnL(newTrade);
                    newTrade.rMultiple = calculateRMultiple(newTrade, newTrade.pnl);
                    
                    trades.push(newTrade);
                }

                saveTrades();
                updateDashboard();
                renderTradesTable();
                renderCalendar();
                alert(`Imported ${lines.length - 1} trades successfully!`);
            };
            
            reader.readAsText(file);
        }

        function exportToCSV() {
            const headers = ['Date', 'Symbol', 'Direction', 'Quantity', 'Entry Price', 'Exit Price', 'Stop Loss', 'Take Profit', 'P&L', 'R Multiple', 'Notes', 'Tags'];
            const csvContent = [
                headers.join(','),
                ...trades.map(trade => [
                    trade.date,
                    trade.symbol,
                    trade.direction,
                    trade.quantity,
                    trade.entryPrice,
                    trade.exitPrice,
                    trade.stopLoss || '',
                    trade.takeProfit || '',
                    trade.pnl,
                    trade.rMultiple,
                    `"${trade.notes.replace(/"/g, '""')}"`,
                    trade.tags
                ].join(','))
            ].join('\n');

            downloadFile('trading-journal.csv', csvContent, 'text/csv');
        }

        function exportToJSON() {
            const jsonContent = JSON.stringify(trades, null, 2);
            downloadFile('trading-journal.json', jsonContent, 'application/json');
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all trading data? This action cannot be undone.')) {
                trades = [];
                saveTrades();
                updateDashboard();
                renderTradesTable();
                renderCalendar();
                alert('All data has been cleared.');
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
        }

        // Load theme preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark');
        }
    </script>
</body>
</html>
                